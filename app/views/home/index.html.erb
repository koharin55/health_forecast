<div class="w-full">
  <!-- Header -->
  <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4 mb-8 sm:mb-12">
    <h1 class="text-3xl sm:text-4xl font-bold text-slate-900">ダッシュボード</h1>
    <%= link_to new_health_record_path, class: "btn-primary w-full md:w-auto px-6 py-3 rounded-xl font-bold inline-flex items-center justify-center" do %>
      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
      </svg>
      <span>新規記録</span>
    <% end %>
  </div>

  <!-- 統計サマリーカード -->
  <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-6 mb-8 sm:mb-12">
    <!-- 総記録数 -->
    <div class="card rounded-2xl p-4 sm:p-6 animate-fade-in-up delay-100">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
        <div class="mb-3 sm:mb-0">
          <p class="text-xs sm:text-sm text-slate-600 font-medium mb-1">総記録数</p>
          <p class="text-2xl sm:text-4xl font-bold text-slate-900 mono"><%= @total_records %></p>
        </div>
        <div class="icon-gradient w-12 h-12 sm:w-14 sm:h-14 rounded-2xl flex items-center justify-center">
          <svg class="w-6 h-6 sm:w-7 sm:h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
        </div>
      </div>
    </div>

    <% if @latest_record %>
      <!-- 最新体重 -->
      <div class="card rounded-2xl p-4 sm:p-6 animate-fade-in-up delay-200">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
          <div class="mb-3 sm:mb-0">
            <p class="text-xs sm:text-sm text-slate-600 font-medium mb-1">最新体重</p>
            <p class="text-2xl sm:text-4xl font-bold text-slate-900 mono">
              <%= @latest_record.weight.present? ? @latest_record.weight.to_s : "➖" %>
              <% if @latest_record.weight.present? %>
                <span class="text-base sm:text-xl text-slate-600">kg</span>
              <% end %>
            </p>
          </div>
          <div class="icon-gradient w-12 h-12 sm:w-14 sm:h-14 rounded-2xl flex items-center justify-center">
            <svg class="w-6 h-6 sm:w-7 sm:h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"/>
            </svg>
          </div>
        </div>
      </div>

      <!-- 最新体調 -->
      <div class="card rounded-2xl p-4 sm:p-6 animate-fade-in-up delay-300">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
          <div class="mb-3 sm:mb-0">
            <p class="text-xs sm:text-sm text-slate-600 font-medium mb-1">最新体調</p>
            <p class="text-2xl sm:text-4xl font-bold text-emerald-600">
              <%= @latest_record.mood.present? ? mood_text(@latest_record.mood) : "➖" %>
            </p>
          </div>
          <div class="icon-gradient w-12 h-12 sm:w-14 sm:h-14 rounded-2xl flex items-center justify-center text-3xl">
            <%= mood_emoji(@latest_record.mood) %>
          </div>
        </div>
      </div>

      <!-- 平均睡眠時間 -->
      <div class="card rounded-2xl p-4 sm:p-6 animate-fade-in-up delay-400">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
          <div class="mb-3 sm:mb-0">
            <p class="text-xs sm:text-sm text-slate-600 font-medium mb-1">平均睡眠</p>
            <% avg_sleep = @recent_records.where.not(sleep_hours: nil).average(:sleep_hours) %>
            <p class="text-2xl sm:text-4xl font-bold text-slate-900 mono">
              <%= avg_sleep.present? ? avg_sleep.round(1).to_s : "➖" %>
              <% if avg_sleep.present? %>
                <span class="text-base sm:text-xl text-slate-600">h</span>
              <% end %>
            </p>
          </div>
          <div class="icon-gradient w-12 h-12 sm:w-14 sm:h-14 rounded-2xl flex items-center justify-center">
            <svg class="w-6 h-6 sm:w-7 sm:h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
            </svg>
          </div>
        </div>
      </div>
    <% else %>
      <!-- 記録がない場合 -->
      <div class="card rounded-2xl p-6 col-span-2 lg:col-span-3 animate-fade-in-up delay-200">
        <h3 class="text-slate-500 text-sm font-semibold mb-2">まだ記録がありません</h3>
        <p class="text-sm text-slate-600">最初の健康記録を追加しましょう</p>
      </div>
    <% end %>
  </div>

  <!-- グラフセクション -->
  <% if @recent_records.any? %>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 mb-8 sm:mb-12">
      <!-- 体重グラフ -->
      <div class="card rounded-2xl p-4 sm:p-6">
        <h3 class="text-base sm:text-xl font-bold mb-4 sm:mb-6 text-slate-900">
          体重の推移
          <span class="text-xs sm:text-sm font-normal text-slate-500 ml-2">最近7日間</span>
        </h3>
        <div style="height: 200px;">
          <canvas id="weightChart"></canvas>
        </div>
      </div>

      <!-- 睡眠時間グラフ -->
      <div class="card rounded-2xl p-4 sm:p-6">
        <h3 class="text-base sm:text-xl font-bold mb-4 sm:mb-6 text-slate-900">
          睡眠時間の推移
          <span class="text-xs sm:text-sm font-normal text-slate-500 ml-2">最近7日間</span>
        </h3>
        <div style="height: 200px;">
          <canvas id="sleepChart"></canvas>
        </div>
      </div>

      <!-- 体調グラフ -->
      <div class="card rounded-2xl p-4 sm:p-6">
        <h3 class="text-base sm:text-xl font-bold mb-4 sm:mb-6 text-slate-900">
          体調スコアの推移
          <span class="text-xs sm:text-sm font-normal text-slate-500 ml-2">最近7日間</span>
        </h3>
        <div style="height: 200px;">
          <canvas id="moodChart"></canvas>
        </div>
      </div>

      <!-- 運動時間グラフ -->
      <div class="card rounded-2xl p-4 sm:p-6">
        <h3 class="text-base sm:text-xl font-bold mb-4 sm:mb-6 text-slate-900">
          運動時間の推移
          <span class="text-xs sm:text-sm font-normal text-slate-500 ml-2">最近7日間</span>
        </h3>
        <div style="height: 200px;">
          <canvas id="exerciseChart"></canvas>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener('turbo:load', () => {
        // データ準備
        const weightData = <%= raw @recent_records.where.not(weight: nil).reverse.map { |r| { x: r.recorded_at.to_s, y: r.weight } }.to_json %>;
        const sleepData = <%= raw @recent_records.where.not(sleep_hours: nil).reverse.map { |r| { x: r.recorded_at.to_s, y: r.sleep_hours } }.to_json %>;
        const moodData = <%= raw @recent_records.where.not(mood: nil).reverse.map { |r| { x: r.recorded_at.to_s, y: r.mood } }.to_json %>;
        const exerciseData = <%= raw @recent_records.where.not(exercise_minutes: nil).reverse.map { |r| { x: r.recorded_at.to_s, y: r.exercise_minutes } }.to_json %>;

        // 既存のチャートを破棄
        ['weightChart', 'sleepChart', 'moodChart', 'exerciseChart'].forEach(id => {
          const canvas = document.getElementById(id);
          if (canvas && Chart.getChart(canvas)) {
            Chart.getChart(canvas).destroy();
          }
        });

        // 体重グラフ（Emeraldグラデーション）
        const weightCtx = document.getElementById('weightChart');
        if (weightCtx && weightData.length > 0) {
          const gradient = weightCtx.getContext('2d').createLinearGradient(0, 0, 0, 250);
          gradient.addColorStop(0, 'rgba(16, 185, 129, 0.5)');
          gradient.addColorStop(1, 'rgba(16, 185, 129, 0.0)');

          new Chart(weightCtx, {
            type: 'line',
            data: {
              datasets: [{
                label: '体重 (kg)',
                data: weightData,
                borderColor: '#10b981',
                backgroundColor: gradient,
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointBackgroundColor: '#10b981'
              }]
            },
            options: {
              animation: { duration: 0 },
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: { type: 'time', time: { unit: 'day' } },
                y: { beginAtZero: false }
              },
              plugins: { legend: { display: false } }
            }
          });
        }

        // 睡眠時間グラフ（Cyanグラデーション）
        const sleepCtx = document.getElementById('sleepChart');
        if (sleepCtx && sleepData.length > 0) {
          const gradient = sleepCtx.getContext('2d').createLinearGradient(0, 0, 0, 250);
          gradient.addColorStop(0, 'rgba(6, 182, 212, 0.5)');
          gradient.addColorStop(1, 'rgba(6, 182, 212, 0.0)');

          new Chart(sleepCtx, {
            type: 'line',
            data: {
              datasets: [{
                label: '睡眠時間 (時間)',
                data: sleepData,
                borderColor: '#06b6d4',
                backgroundColor: gradient,
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointBackgroundColor: '#06b6d4'
              }]
            },
            options: {
              animation: { duration: 0 },
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: { type: 'time', time: { unit: 'day' } },
                y: { beginAtZero: true }
              },
              plugins: { legend: { display: false } }
            }
          });
        }

        // 体調グラフ（Amberグラデーション、y軸1-5固定）
        const moodCtx = document.getElementById('moodChart');
        if (moodCtx && moodData.length > 0) {
          const gradient = moodCtx.getContext('2d').createLinearGradient(0, 0, 0, 250);
          gradient.addColorStop(0, 'rgba(245, 158, 11, 0.5)');
          gradient.addColorStop(1, 'rgba(245, 158, 11, 0.0)');

          new Chart(moodCtx, {
            type: 'line',
            data: {
              datasets: [{
                label: '体調スコア',
                data: moodData,
                borderColor: '#f59e0b',
                backgroundColor: gradient,
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointBackgroundColor: '#f59e0b'
              }]
            },
            options: {
              animation: { duration: 0 },
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: { type: 'time', time: { unit: 'day' } },
                y: { min: 1, max: 5, ticks: { stepSize: 1 } }
              },
              plugins: { legend: { display: false } }
            }
          });
        }

        // 運動時間グラフ（棒グラフ、Emerald-Cyanグラデーション）
        const exerciseCtx = document.getElementById('exerciseChart');
        if (exerciseCtx && exerciseData.length > 0) {
          const gradient = exerciseCtx.getContext('2d').createLinearGradient(0, 0, 0, 250);
          gradient.addColorStop(0, 'rgba(16, 185, 129, 0.8)');
          gradient.addColorStop(1, 'rgba(6, 182, 212, 0.8)');

          new Chart(exerciseCtx, {
            type: 'bar',
            data: {
              datasets: [{
                label: '運動時間 (分)',
                data: exerciseData,
                backgroundColor: gradient,
                borderColor: '#10b981',
                borderWidth: 1
              }]
            },
            options: {
              animation: { duration: 0 },
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: { type: 'time', time: { unit: 'day' } },
                y: { beginAtZero: true }
              },
              plugins: { legend: { display: false } }
            }
          });
        }
      });
    </script>
  <% end %>

  <!-- 最近の記録 -->
  <div class="card rounded-2xl">
    <div class="px-4 sm:px-6 py-4 sm:py-5 border-b border-slate-200">
      <div class="flex justify-between items-center">
        <h3 class="text-lg sm:text-xl font-bold text-slate-900">最近の記録</h3>
        <%= link_to health_records_path, class: "text-emerald-600 hover:text-emerald-700 font-semibold inline-flex items-center transition-colors text-sm sm:text-base" do %>
          すべて見る
          <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
          </svg>
        <% end %>
      </div>
    </div>
    <div class="p-4 sm:p-6">

    <% if @recent_records.any? %>
      <!-- モバイル：カードビュー -->
      <div class="grid grid-cols-1 gap-4 md:hidden">
        <% @recent_records.limit(5).each do |record| %>
          <div class="card p-4 border border-gray-200">
            <div class="flex justify-between items-start mb-3">
              <div class="text-sm font-semibold text-slate-800">
                <%= record.recorded_at.strftime("%Y年%m月%d日") %>
              </div>
              <% if record.mood.present? %>
                <span class="<%= mood_badge_class(record.mood) %>">
                  <%= mood_emoji(record.mood) %>
                  <%= mood_text(record.mood) %>
                </span>
              <% end %>
            </div>
            <div class="grid grid-cols-2 gap-2 mb-3 text-sm">
              <div>
                <span class="text-slate-500">体重:</span>
                <span class="font-semibold"><%= record.weight.present? ? "#{record.weight} kg" : "➖" %></span>
              </div>
              <div>
                <span class="text-slate-500">睡眠:</span>
                <span class="font-semibold"><%= record.sleep_hours.present? ? "#{record.sleep_hours}h" : "➖" %></span>
              </div>
              <div>
                <span class="text-slate-500">運動:</span>
                <span class="font-semibold"><%= record.exercise_minutes.present? ? "#{record.exercise_minutes}分" : "➖" %></span>
              </div>
            </div>
            <div class="flex gap-2">
              <%= link_to "詳細", record, class: "btn-secondary flex-1 text-center text-sm py-2" %>
              <%= link_to "編集", edit_health_record_path(record), class: "btn-primary flex-1 text-center text-sm py-2" %>
            </div>
          </div>
        <% end %>
      </div>

      <!-- デスクトップ：テーブルビュー -->
      <div class="hidden md:block overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50 bg-opacity-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">日付</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">体重</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">睡眠</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">運動</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">体調</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">操作</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            <% @recent_records.limit(10).each do |record| %>
              <tr class="hover:bg-gray-50 hover:bg-opacity-50 transition">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900">
                  <%= record.recorded_at.strftime("%Y-%m-%d") %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 mono">
                  <%= record.weight.present? ? "#{record.weight} kg" : "➖" %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 mono">
                  <%= record.sleep_hours.present? ? "#{record.sleep_hours}h" : "➖" %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 mono">
                  <%= record.exercise_minutes.present? ? "#{record.exercise_minutes}分" : "➖" %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900">
                  <% if record.mood.present? %>
                    <span class="<%= mood_badge_class(record.mood) %>">
                      <%= mood_emoji(record.mood) %>
                      <%= mood_text(record.mood) %>
                    </span>
                  <% else %>
                    ➖
                  <% end %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                  <%= link_to "詳細", record, class: "text-emerald-600 hover:text-emerald-900 mr-3" %>
                  <%= link_to "編集", edit_health_record_path(record), class: "text-cyan-600 hover:text-cyan-900" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <div class="mt-4 text-center">
        <%= link_to "すべての記録を見る →", health_records_path, class: "text-emerald-600 hover:text-emerald-900 font-semibold" %>
      </div>
    <% else %>
      <p class="text-slate-600 text-center py-8">まだ記録がありません。最初の記録を追加しましょう！</p>
    <% end %>
  </div>
</div>
