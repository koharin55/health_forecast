<div class="w-full">
  <!-- Header -->
  <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4 mb-8">
    <h1 class="text-4xl font-bold text-gray-800">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
    <%= link_to new_health_record_path, class: "btn-primary w-full md:w-auto" do %>
      <span>â• æ–°ã—ã„è¨˜éŒ²ã‚’è¿½åŠ </span>
    <% end %>
  </div>

  <!-- çµ±è¨ˆã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
    <!-- ç·è¨˜éŒ²æ•° -->
    <div class="card p-6 animate-fade-in-up delay-100">
      <div class="icon-gradient mb-3">
        <span>ğŸ“Š</span>
      </div>
      <h3 class="text-gray-500 text-sm font-semibold mb-2">ç·è¨˜éŒ²æ•°</h3>
      <p class="text-3xl font-bold text-gray-800 mono"><%= @total_records %></p>
    </div>

    <% if @latest_record %>
      <!-- æœ€æ–°ä½“é‡ -->
      <div class="card p-6 animate-fade-in-up delay-200">
        <div class="icon-gradient mb-3">
          <span>âš–ï¸</span>
        </div>
        <h3 class="text-gray-500 text-sm font-semibold mb-2">æœ€æ–°ã®ä½“é‡</h3>
        <p class="text-3xl font-bold text-gray-800 mono">
          <%= @latest_record.weight.present? ? @latest_record.weight.to_s : "â–" %>
        </p>
        <% if @latest_record.weight.present? %>
          <p class="text-xs text-gray-500 mt-1">kg</p>
        <% end %>
      </div>

      <!-- æœ€æ–°ä½“èª¿ -->
      <div class="card p-6 animate-fade-in-up delay-300">
        <div class="icon-gradient mb-3">
          <span><%= mood_emoji(@latest_record.mood) %></span>
        </div>
        <h3 class="text-gray-500 text-sm font-semibold mb-2">æœ€æ–°ã®ä½“èª¿</h3>
        <p class="text-3xl font-bold text-gray-800 mono">
          <%= @latest_record.mood.present? ? @latest_record.mood.to_s : "â–" %>
        </p>
        <% if @latest_record.mood.present? %>
          <p class="text-xs text-gray-500 mt-1">/ 5</p>
        <% end %>
      </div>

      <!-- å¹³å‡ç¡çœ æ™‚é–“ -->
      <div class="card p-6 animate-fade-in-up delay-400">
        <div class="icon-gradient mb-3">
          <span>ğŸ˜´</span>
        </div>
        <h3 class="text-gray-500 text-sm font-semibold mb-2">å¹³å‡ç¡çœ </h3>
        <% avg_sleep = @recent_records.where.not(sleep_hours: nil).average(:sleep_hours) %>
        <p class="text-3xl font-bold text-gray-800 mono">
          <%= avg_sleep.present? ? avg_sleep.round(1).to_s : "â–" %>
        </p>
        <% if avg_sleep.present? %>
          <p class="text-xs text-gray-500 mt-1">æ™‚é–“</p>
        <% end %>
      </div>
    <% else %>
      <!-- è¨˜éŒ²ãŒãªã„å ´åˆ -->
      <div class="card p-6 col-span-3 animate-fade-in-up delay-200">
        <h3 class="text-gray-500 text-sm font-semibold mb-2">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</h3>
        <p class="text-sm text-gray-600">æœ€åˆã®å¥åº·è¨˜éŒ²ã‚’è¿½åŠ ã—ã¾ã—ã‚‡ã†</p>
      </div>
    <% end %>
  </div>

  <!-- ã‚°ãƒ©ãƒ•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
  <% if @recent_records.any? %>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <!-- ä½“é‡ã‚°ãƒ©ãƒ• -->
      <div class="card p-6">
        <h3 class="text-xl font-bold mb-4 text-gray-800">ä½“é‡ã®æ¨ç§»</h3>
        <div style="position: relative; height: 250px;">
          <canvas id="weightChart"></canvas>
        </div>
      </div>

      <!-- ç¡çœ æ™‚é–“ã‚°ãƒ©ãƒ• -->
      <div class="card p-6">
        <h3 class="text-xl font-bold mb-4 text-gray-800">ç¡çœ æ™‚é–“ã®æ¨ç§»</h3>
        <div style="position: relative; height: 250px;">
          <canvas id="sleepChart"></canvas>
        </div>
      </div>

      <!-- ä½“èª¿ã‚°ãƒ©ãƒ• -->
      <div class="card p-6">
        <h3 class="text-xl font-bold mb-4 text-gray-800">ä½“èª¿ã‚¹ã‚³ã‚¢ã®æ¨ç§»</h3>
        <div style="position: relative; height: 250px;">
          <canvas id="moodChart"></canvas>
        </div>
      </div>

      <!-- é‹å‹•æ™‚é–“ã‚°ãƒ©ãƒ• -->
      <div class="card p-6">
        <h3 class="text-xl font-bold mb-4 text-gray-800">é‹å‹•æ™‚é–“ã®æ¨ç§»</h3>
        <div style="position: relative; height: 250px;">
          <canvas id="exerciseChart"></canvas>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener('turbo:load', () => {
        // ãƒ‡ãƒ¼ã‚¿æº–å‚™
        const weightData = <%= raw @recent_records.where.not(weight: nil).reverse.map { |r| { x: r.recorded_at.to_s, y: r.weight } }.to_json %>;
        const sleepData = <%= raw @recent_records.where.not(sleep_hours: nil).reverse.map { |r| { x: r.recorded_at.to_s, y: r.sleep_hours } }.to_json %>;
        const moodData = <%= raw @recent_records.where.not(mood: nil).reverse.map { |r| { x: r.recorded_at.to_s, y: r.mood } }.to_json %>;
        const exerciseData = <%= raw @recent_records.where.not(exercise_minutes: nil).reverse.map { |r| { x: r.recorded_at.to_s, y: r.exercise_minutes } }.to_json %>;

        // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
        ['weightChart', 'sleepChart', 'moodChart', 'exerciseChart'].forEach(id => {
          const canvas = document.getElementById(id);
          if (canvas && Chart.getChart(canvas)) {
            Chart.getChart(canvas).destroy();
          }
        });

        // ä½“é‡ã‚°ãƒ©ãƒ•ï¼ˆEmeraldã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
        const weightCtx = document.getElementById('weightChart');
        if (weightCtx && weightData.length > 0) {
          const gradient = weightCtx.getContext('2d').createLinearGradient(0, 0, 0, 250);
          gradient.addColorStop(0, 'rgba(16, 185, 129, 0.5)');
          gradient.addColorStop(1, 'rgba(16, 185, 129, 0.0)');

          new Chart(weightCtx, {
            type: 'line',
            data: {
              datasets: [{
                label: 'ä½“é‡ (kg)',
                data: weightData,
                borderColor: '#10b981',
                backgroundColor: gradient,
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointBackgroundColor: '#10b981'
              }]
            },
            options: {
              animation: { duration: 0 },
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: { type: 'time', time: { unit: 'day' } },
                y: { beginAtZero: false }
              },
              plugins: { legend: { display: false } }
            }
          });
        }

        // ç¡çœ æ™‚é–“ã‚°ãƒ©ãƒ•ï¼ˆCyanã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
        const sleepCtx = document.getElementById('sleepChart');
        if (sleepCtx && sleepData.length > 0) {
          const gradient = sleepCtx.getContext('2d').createLinearGradient(0, 0, 0, 250);
          gradient.addColorStop(0, 'rgba(6, 182, 212, 0.5)');
          gradient.addColorStop(1, 'rgba(6, 182, 212, 0.0)');

          new Chart(sleepCtx, {
            type: 'line',
            data: {
              datasets: [{
                label: 'ç¡çœ æ™‚é–“ (æ™‚é–“)',
                data: sleepData,
                borderColor: '#06b6d4',
                backgroundColor: gradient,
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointBackgroundColor: '#06b6d4'
              }]
            },
            options: {
              animation: { duration: 0 },
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: { type: 'time', time: { unit: 'day' } },
                y: { beginAtZero: true }
              },
              plugins: { legend: { display: false } }
            }
          });
        }

        // ä½“èª¿ã‚°ãƒ©ãƒ•ï¼ˆAmberã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€yè»¸1-5å›ºå®šï¼‰
        const moodCtx = document.getElementById('moodChart');
        if (moodCtx && moodData.length > 0) {
          const gradient = moodCtx.getContext('2d').createLinearGradient(0, 0, 0, 250);
          gradient.addColorStop(0, 'rgba(245, 158, 11, 0.5)');
          gradient.addColorStop(1, 'rgba(245, 158, 11, 0.0)');

          new Chart(moodCtx, {
            type: 'line',
            data: {
              datasets: [{
                label: 'ä½“èª¿ã‚¹ã‚³ã‚¢',
                data: moodData,
                borderColor: '#f59e0b',
                backgroundColor: gradient,
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointBackgroundColor: '#f59e0b'
              }]
            },
            options: {
              animation: { duration: 0 },
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: { type: 'time', time: { unit: 'day' } },
                y: { min: 1, max: 5, ticks: { stepSize: 1 } }
              },
              plugins: { legend: { display: false } }
            }
          });
        }

        // é‹å‹•æ™‚é–“ã‚°ãƒ©ãƒ•ï¼ˆæ£’ã‚°ãƒ©ãƒ•ã€Emerald-Cyanã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
        const exerciseCtx = document.getElementById('exerciseChart');
        if (exerciseCtx && exerciseData.length > 0) {
          const gradient = exerciseCtx.getContext('2d').createLinearGradient(0, 0, 0, 250);
          gradient.addColorStop(0, 'rgba(16, 185, 129, 0.8)');
          gradient.addColorStop(1, 'rgba(6, 182, 212, 0.8)');

          new Chart(exerciseCtx, {
            type: 'bar',
            data: {
              datasets: [{
                label: 'é‹å‹•æ™‚é–“ (åˆ†)',
                data: exerciseData,
                backgroundColor: gradient,
                borderColor: '#10b981',
                borderWidth: 1
              }]
            },
            options: {
              animation: { duration: 0 },
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: { type: 'time', time: { unit: 'day' } },
                y: { beginAtZero: true }
              },
              plugins: { legend: { display: false } }
            }
          });
        }
      });
    </script>
  <% end %>

  <!-- æœ€è¿‘ã®è¨˜éŒ² -->
  <div class="card p-6">
    <h3 class="text-xl font-bold mb-4 text-gray-800">æœ€è¿‘ã®è¨˜éŒ²</h3>

    <% if @recent_records.any? %>
      <!-- ãƒ¢ãƒã‚¤ãƒ«ï¼šã‚«ãƒ¼ãƒ‰ãƒ“ãƒ¥ãƒ¼ -->
      <div class="grid grid-cols-1 gap-4 md:hidden">
        <% @recent_records.limit(5).each do |record| %>
          <div class="card p-4 border border-gray-200">
            <div class="flex justify-between items-start mb-3">
              <div class="text-sm font-semibold text-gray-800">
                <%= record.recorded_at.strftime("%Yå¹´%mæœˆ%dæ—¥") %>
              </div>
              <% if record.mood.present? %>
                <span class="<%= mood_badge_class(record.mood) %>">
                  <%= mood_emoji(record.mood) %>
                  <%= mood_text(record.mood) %>
                </span>
              <% end %>
            </div>
            <div class="grid grid-cols-2 gap-2 mb-3 text-sm">
              <div>
                <span class="text-gray-500">ä½“é‡:</span>
                <span class="font-semibold"><%= record.weight.present? ? "#{record.weight} kg" : "â–" %></span>
              </div>
              <div>
                <span class="text-gray-500">ç¡çœ :</span>
                <span class="font-semibold"><%= record.sleep_hours.present? ? "#{record.sleep_hours}h" : "â–" %></span>
              </div>
              <div>
                <span class="text-gray-500">é‹å‹•:</span>
                <span class="font-semibold"><%= record.exercise_minutes.present? ? "#{record.exercise_minutes}åˆ†" : "â–" %></span>
              </div>
            </div>
            <div class="flex gap-2">
              <%= link_to "è©³ç´°", record, class: "btn-secondary flex-1 text-center text-sm py-2" %>
              <%= link_to "ç·¨é›†", edit_health_record_path(record), class: "btn-primary flex-1 text-center text-sm py-2" %>
            </div>
          </div>
        <% end %>
      </div>

      <!-- ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ï¼šãƒ†ãƒ¼ãƒ–ãƒ«ãƒ“ãƒ¥ãƒ¼ -->
      <div class="hidden md:block overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50 bg-opacity-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ—¥ä»˜</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ä½“é‡</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç¡çœ </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é‹å‹•</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ä½“èª¿</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            <% @recent_records.limit(10).each do |record| %>
              <tr class="hover:bg-gray-50 hover:bg-opacity-50 transition">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  <%= record.recorded_at.strftime("%Y-%m-%d") %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 mono">
                  <%= record.weight.present? ? "#{record.weight} kg" : "â–" %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 mono">
                  <%= record.sleep_hours.present? ? "#{record.sleep_hours}h" : "â–" %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 mono">
                  <%= record.exercise_minutes.present? ? "#{record.exercise_minutes}åˆ†" : "â–" %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  <% if record.mood.present? %>
                    <span class="<%= mood_badge_class(record.mood) %>">
                      <%= mood_emoji(record.mood) %>
                      <%= mood_text(record.mood) %>
                    </span>
                  <% else %>
                    â–
                  <% end %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                  <%= link_to "è©³ç´°", record, class: "text-emerald-600 hover:text-emerald-900 mr-3" %>
                  <%= link_to "ç·¨é›†", edit_health_record_path(record), class: "text-cyan-600 hover:text-cyan-900" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <div class="mt-4 text-center">
        <%= link_to "ã™ã¹ã¦ã®è¨˜éŒ²ã‚’è¦‹ã‚‹ â†’", health_records_path, class: "text-emerald-600 hover:text-emerald-900 font-semibold" %>
      </div>
    <% else %>
      <p class="text-gray-600 text-center py-8">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®è¨˜éŒ²ã‚’è¿½åŠ ã—ã¾ã—ã‚‡ã†ï¼</p>
    <% end %>
  </div>
</div>
