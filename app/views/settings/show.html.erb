<div class="max-w-2xl mx-auto">
  <h1 class="text-2xl sm:text-3xl font-bold text-slate-800 mb-6">設定</h1>

  <div class="card rounded-2xl p-6 sm:p-8 mb-6" data-controller="location-setting">
    <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
      <span class="text-2xl">&#128205;</span>
      地域設定
    </h2>
    <p class="text-slate-600 mb-6">
      地域を設定すると、健康記録に天候情報が自動的に追加されます。
      天候データは体調との相関分析に活用されます。
    </p>

    <% if @user.location_configured? %>
      <div class="bg-emerald-50 border border-emerald-200 rounded-xl p-4 mb-6">
        <p class="text-emerald-800 font-medium">
          <span class="text-lg mr-1">&#9989;</span>
          現在の設定: <span class="font-bold"><%= @user.location_name %></span>
        </p>
        <p class="text-sm text-emerald-600 mt-1">
          緯度: <%= @user.latitude %>, 経度: <%= @user.longitude %>
        </p>
      </div>
    <% else %>
      <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-6">
        <p class="text-amber-800">
          <span class="text-lg mr-1">&#9888;&#65039;</span>
          地域が設定されていません。天候情報を記録するには地域を設定してください。
        </p>
      </div>
    <% end %>

    <%= form_with url: settings_path, method: :patch, local: true, data: { location_setting_target: "form" } do |f| %>
      <div class="mb-6">
        <p class="font-medium text-slate-700 mb-3">地域の指定方法</p>
        <div class="space-y-3">
          <label class="flex items-center gap-3 p-3 border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50 transition-colors">
            <input type="radio" name="location_type" value="prefecture" class="w-5 h-5 text-emerald-500" data-action="change->location-setting#toggleType" data-location-setting-target="prefectureRadio" checked>
            <span class="text-slate-700">都道府県から選択</span>
          </label>
          <label class="flex items-center gap-3 p-3 border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50 transition-colors">
            <input type="radio" name="location_type" value="zipcode" class="w-5 h-5 text-emerald-500" data-action="change->location-setting#toggleType" data-location-setting-target="zipcodeRadio">
            <span class="text-slate-700">郵便番号を入力</span>
          </label>
        </div>
      </div>

      <!-- 都道府県選択 -->
      <div data-location-setting-target="prefectureSection" class="mb-6">
        <label class="block font-medium text-slate-700 mb-2">都道府県</label>
        <%= f.select :prefecture_code, @prefecture_options, { include_blank: "選択してください" }, class: "w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all" %>
      </div>

      <!-- 郵便番号入力 -->
      <div data-location-setting-target="zipcodeSection" class="mb-6" style="display: none;">
        <label class="block font-medium text-slate-700 mb-2">郵便番号</label>
        <div class="flex gap-3">
          <input type="text" name="zipcode" placeholder="例: 160-0023" class="flex-1 px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all" data-location-setting-target="zipcodeInput" data-action="input->location-setting#clearResult">
          <button type="button" class="px-4 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl font-medium transition-colors" data-action="click->location-setting#searchZipcode">
            検索
          </button>
        </div>
        <div data-location-setting-target="zipcodeResult" class="mt-3"></div>
      </div>

      <button type="submit" class="w-full btn-primary text-white py-3 px-6 rounded-xl font-bold text-lg transition-all">
        設定を保存
      </button>
    <% end %>
  </div>

  <!-- 過去データ天候取得 -->
  <% if @user.location_configured? %>
    <div class="card rounded-2xl p-6 sm:p-8 mb-6">
      <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
        <span class="text-2xl">&#9729;&#65039;</span>
        過去データの天候取得
      </h2>
      <p class="text-slate-600 mb-4">
        天候情報がない過去の健康記録に、天候データを追加します。
      </p>
      <div class="bg-slate-50 border border-slate-200 rounded-xl p-4 mb-4">
        <p class="text-sm text-slate-600">
          <span class="font-medium">取得可能範囲:</span> 過去92日以内の記録<br>
          <span class="font-medium">対象:</span> 天候データが未設定の記録
        </p>
      </div>
      <%= button_to "過去データの天候を取得", backfill_weather_settings_path,
          method: :post,
          class: "w-full btn-secondary py-3 px-6 rounded-xl font-bold text-lg transition-all",
          data: { turbo_confirm: "過去92日以内の記録に天候データを取得します。よろしいですか？" } %>
    </div>
  <% end %>

  <div class="text-center">
    <%= link_to "ダッシュボードに戻る", root_path, class: "text-emerald-600 hover:text-emerald-700 font-medium" %>
  </div>
</div>
