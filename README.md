# PreCare - 予防ケア健康管理アプリケーション

PreCareは、日々の健康データを記録・可視化し、AIを活用した週次レポートや体調予測・アドバイスを提供する予防ケア型健康管理アプリケーションです。

## 概要

このアプリケーションは、以下の内容に基づいて設計された健康管理システムです：

- PCとスマホ両方で閲覧可能なレスポンシブデザイン
- 手動入力による健康データの記録
- データのグラフ表示と簡単な統計
- AIによる週次レポート生成と体調予測
- 天候データと体調の相関分析
- 将来的なApple Health/HealthKit連携の準備

## 主な機能

### 現在実装済みの機能

1. **ユーザー認証**
   - メールアドレスとパスワードによるユーザー登録・ログイン
   - Deviseを使用したセキュアな認証システム
   - 日本語化されたエラーメッセージとUI

2. **健康データ記録**
   - 体重（kg）
   - 睡眠時間（時間）
   - 運動時間（分）
   - 体調スコア（1-5段階）
   - 歩数
   - 心拍数（bpm）
   - 血圧（収縮期/拡張期 mmHg）
   - 体温（℃）
   - メモ（自由記述）

3. **天候情報連携**
   - Open-Meteo APIによる天候データ自動取得
   - 健康記録保存時に天候情報を自動記録（気温、湿度、気圧、天気）
   - 地域設定（都道府県選択または郵便番号入力）
   - 過去データへの天候情報バックフィル機能（92日以内）
   - ダッシュボードに現在の天気を表示

4. **AI週次レポート**
   - Gemini API（gemini-2.5-flash）を使用したAI分析
   - 今週の振り返り（体調・睡眠・運動の傾向サマリー）
   - 傾向分析（過去データからのパターン発見）
   - 翌週の体調予測（天気予報との連携）
   - 具体的な注意点と過ごし方アドバイス
   - 体調不良時の回復方法提案
   - オンデマンド生成（ボタン押下時に生成）
   - レポート履歴の閲覧

5. **体調予測機能**
   - 気象感度スコアによる個人化された予測
   - 天気予報に基づく4日間の体調予測表示
   - 低気圧・気温変化による体調リスク分析

6. **ダッシュボード**
   - AIアドバイスカード（最上部に配置）
   - 今日の天気と4日間の体調予測
   - 統計サマリー（総記録数、最新の体重・体調）
   - グラフ表示（体重、睡眠時間、体調スコア、運動時間の推移）
   - 最近の記録一覧
   - 週次レポートカード

7. **記録管理**
   - 記録の一覧表示（天候情報含む）
   - 記録の詳細表示
   - 記録の編集・削除

8. **PWA対応**
   - ホーム画面への追加
   - プッシュ通知機能
   - オフライン対応

### 今後追加予定の機能

- Apple Health / HealthKitからのデータ自動連携（iOSアプリ開発）
- 高リスク週の自動レポート生成とプッシュ通知
- 過去データの詳細分析とレポート生成

## 技術スタック

- **フレームワーク**: Ruby on Rails 7.1.6
- **Ruby**: 3.2.0
- **データベース**: SQLite3（開発環境）
- **認証**: Devise 5.0.0
- **フロントエンド**:
  - Tailwind CSS（レスポンシブデザイン）
  - Hotwire (Turbo & Stimulus)
  - Chartkick（グラフ表示）
  - Google Fonts（Zen Maru Gothic - 柔らかい日本語フォント）
- **データ分析**: Groupdate
- **AI/機械学習**:
  - Gemini API（gemini-2.5-flash モデル）
  - gemini-ai gem
- **Markdown**: Redcarpet gem（レポート表示用）
- **外部API**:
  - Open-Meteo API（天候データ取得、無料・APIキー不要）
  - Zipcloud API（郵便番号→住所変換）
  - Google Generative AI（Gemini API）
- **テスト**: RSpec, WebMock

## セットアップ手順

### 前提条件

- Ruby 3.2.0
- Rails 7.1.6
- SQLite3
- Gemini API キー（AI週次レポート機能を使用する場合）

### インストール

1. リポジトリのクローン（または既存ディレクトリで作業）

```bash
cd health_forecast
```

2. 依存関係のインストール

```bash
bundle install
```

3. データベースのセットアップ

```bash
rails db:create
rails db:migrate
```

4. Gemini APIキーの設定（AI週次レポート機能を使用する場合）

```bash
# 環境変数として設定
export GEMINI_API_KEY=your_api_key_here

# または ~/.profile に追加
echo 'export GEMINI_API_KEY=your_api_key_here' >> ~/.profile
source ~/.profile
```

5. サーバーの起動

```bash
bin/dev
```

または

```bash
rails server
```

6. ブラウザで http://localhost:3000 にアクセス

## 使い方

1. **ユーザー登録**
   - トップページから「新規登録」をクリック
   - メールアドレスとパスワードを入力して登録

2. **ログイン**
   - 登録したメールアドレスとパスワードでログイン

3. **健康記録の追加**
   - ダッシュボードまたは「健康記録」ページから「新しい記録を追加」をクリック
   - 記録日と各種健康データを入力
   - 「記録を追加」ボタンで保存

4. **データの閲覧**
   - ダッシュボード：最近の記録とグラフで推移を確認
   - 健康記録一覧：すべての記録を一覧表示
   - 詳細表示：個別の記録を詳しく確認

5. **AI週次レポートの生成**
   - ダッシュボードの「AI週次レポート」カードから「今週のレポートを生成」をクリック
   - AIが過去7日間のデータを分析し、レポートを生成
   - 翌週の天気予報に基づいた体調予測と具体的なアドバイスを確認

6. **記録の編集・削除**
   - 各記録の「編集」ボタンでデータを修正
   - 「削除」ボタンで不要な記録を削除

## 機能仕様

### 体調スコア（mood）

| スコア | テキスト | 絵文字 |
|--------|---------|--------|
| 1 | とても悪い | 😞 |
| 2 | 悪い | 😕 |
| 3 | 普通 | 😐 |
| 4 | 良い | 😊 |
| 5 | とても良い | 😄 |
| 未入力 | 未記録 | ➖ |

### 天気表示

ユーザーの登録地域（都道府県または郵便番号）に基づき、Open-Meteo APIから天気を自動取得します。

| アイコン | 天気 |
|---------|------|
| ☀️ | 快晴 |
| 🌤️ | 晴れ / 一部曇り |
| ☁️ | 曇り |
| 🌫️ | 霧 / 霧氷 |
| 🌧️ | 霧雨 / 雨（弱い〜強い） |
| 🌦️ | にわか雨（弱い〜激しい） |
| ❄️ | 雪（弱い〜強い） / 霧雪 |
| 🌨️ | にわか雪 |
| ⛈️ | 雷雨 / 雷雨（雹あり） |

### 体調予測

天気予報（特に気圧）とユーザーの過去の記録から算出した気象感度を組み合わせて、最大4日先までの体調リスクを予測します。

#### リスクレベル（4段階）

| レベル | ラベル | スコア範囲 | アドバイス例 |
|--------|--------|-----------|-------------|
| low | 良好 | 0〜25 | 良好な天気が予想されます。快適にお過ごしいただけそうです。 |
| moderate | 注意 | 26〜50 | 通常通りお過ごしいただけますが、体調の変化には注意してください。 |
| high | 警戒 | 51〜75 | 気圧変化による体調不良に注意。頭痛薬の準備をおすすめします。 |
| critical | 要注意 | 76〜100 | 体調変化に十分注意してください。頭痛薬などを準備し、無理のない予定を心がけましょう。 |

#### リスクスコアに影響する要因

| 要因 | 影響 |
|------|------|
| 気圧（予報値） | 1000hPa未満（低気圧）で大きくリスク上昇 / 1020hPa以上（高気圧）でリスク低下 |
| 気圧変化 | 現在と予報の差が大きいほどリスク上昇 |
| 天気 | 雨 / 雷雨 / 雪でリスク上昇 |
| 個人の気象感度 | 過去の記録から自動算出（データ不足時はデフォルト値を使用） |

#### 警告メッセージ例

- 「低気圧（1002hPa）」
- 「やや低い気圧（1008hPa）」
- 「気圧が12hPa低下予報」
- 「雨の予報」「雷雨の予報」

### 気圧レベルの分類

| 気圧 (hPa) | レベル |
|------------|--------|
| 〜999 | 低気圧 |
| 1000〜1012 | やや低い |
| 1013〜1019 | 通常 |
| 1020〜 | 高気圧 |

### 週次AIレポート

Gemini AI（gemini-2.5-flash）を活用し、1週間分の健康記録・天気データ・体調予測を分析して自動生成されるレポートです。今週の振り返り、傾向分析、翌週の体調予測、具体的なアドバイスが含まれます。

### 位置情報の設定

体調予測と天気取得に必要です。以下の方法で設定できます：

- **都道府県から選択**
- **郵便番号を入力**（Zipcloud APIで自動的に住所・緯度経度を取得）

## データモデル

### User（ユーザー）
- email（メールアドレス）
- encrypted_password（暗号化パスワード）
- latitude（緯度）※地域設定用
- longitude（経度）※地域設定用
- location_name（地域名）※表示用

### HealthRecord（健康記録）
- user_id（ユーザーID）
- recorded_at（記録日）
- weight（体重）
- sleep_hours（睡眠時間）
- exercise_minutes（運動時間）
- mood（体調スコア 1-5）
- notes（メモ）
- steps（歩数）
- heart_rate（心拍数）
- systolic_pressure（収縮期血圧）
- diastolic_pressure（拡張期血圧）
- body_temperature（体温）
- weather_temperature（天気: 気温）
- weather_humidity（天気: 湿度）
- weather_pressure（天気: 気圧）
- weather_code（天気: WMOコード）
- weather_description（天気: 説明）

### WeeklyReport（週次レポート）
- user_id（ユーザーID）
- week_start（週の開始日）
- week_end（週の終了日）
- content（AI生成レポート本文）
- summary_data（数値サマリー: JSON）
- predictions（翌週予測データ: JSON）
- tokens_used（使用トークン数）

## 開発のロードマップ

### フェーズ1（完了）
✅ Rails Web版の基本機能
✅ ユーザー認証
✅ 手動入力によるデータ記録
✅ グラフ表示と簡単な分析
✅ レスポンシブデザイン

### フェーズ2（完了）
✅ PWA化（ホーム画面追加）
✅ プッシュ通知機能
✅ 天候情報連携（Open-Meteo API）
✅ 地域設定（都道府県/郵便番号）
✅ 過去データ天候バックフィル

### フェーズ3（完了）
✅ Gemini APIを使用したAI週次レポート
✅ 天候データと体調の相関分析
✅ パーソナライズされたアドバイス生成
✅ 体調予測機能（天気予報連携）

### フェーズ4（予定）
- iOSアプリ開発（Swift）
- HealthKit連携
- データの自動同期
- 高リスク週の自動通知

## デプロイ

本番環境へのデプロイ時は、以下の設定が必要です：

1. 環境変数の設定
   - `SECRET_KEY_BASE`
   - `GEMINI_API_KEY`（AI機能を使用する場合）
   - データベース接続情報（本番環境ではPostgreSQLを推奨）

2. アセットのプリコンパイル

```bash
RAILS_ENV=production rails assets:precompile
```

3. データベースマイグレーション

```bash
RAILS_ENV=production rails db:migrate
```

## ライセンス

このプロジェクトは個人開発プロジェクトです。

## 貢献

個人プロジェクトですが、改善提案やバグ報告は歓迎します。

## お問い合わせ

質問や提案がある場合は、プロジェクトのIssueまでお願いします。

---

**注意**: 本アプリケーションは医療アドバイスを提供するものではありません。健康上の懸念がある場合は、必ず医療専門家にご相談ください。
